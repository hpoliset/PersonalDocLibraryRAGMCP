<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Document Library MCP Server - Architecture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        h3 {
            color: #764ba2;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }
        
        .architecture-diagram {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        
        .component {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .component h4 {
            margin-bottom: 5px;
            color: white;
        }
        
        .component p, .component ul, .component li {
            color: white;
        }
        
        .component ul {
            padding-left: 20px;
        }
        
        .component pre, .component code {
            background: rgba(255, 255, 255, 0.1);
            color: #f0f0f0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .file-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .file-list ul {
            list-style-type: none;
            padding-left: 20px;
        }
        
        .file-list li {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .file-list li:last-child {
            border-bottom: none;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #e9ecef;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card h3 {
            color: white;
            font-size: 2em;
            margin: 0;
        }
        
        .stat-card p {
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .flow-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px;
            border: 2px solid #667eea;
        }
        
        .flow-arrow {
            font-size: 2em;
            color: #667eea;
            margin: 0 10px;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîÆ Personal Document Library MCP Server</h1>
            <p>Production-Ready Architecture Documentation</p>
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; margin-top: 15px;">
                <strong>‚úÖ FULLY OPERATIONAL</strong> - ARM64 compatible, 768-dim embeddings, 14 MCP tools working
            </div>
        </header>

        <div class="section">
            <h2>System Overview</h2>
            <p>The Personal Document Library MCP Server is a sophisticated system that enables Claude to access and analyze a personal collection of documents through RAG (Retrieval-Augmented Generation). It supports PDFs, Word documents, EPUBs, MOBI/Kindle ebooks, and more. The system provides semantic search, vector storage, and intelligent synthesis capabilities.</p>
            
            <div class="stats">
                <div class="stat-card">
                    <h3>XX</h3>
                    <p>Indexed Books</p>
                </div>
                <div class="stat-card">
                    <h3>XX,XXX</h3>
                    <p>Text Chunks</p>
                </div>
                <div class="stat-card">
                    <h3>~XX,XXX</h3>
                    <p>Total Pages</p>
                </div>
                <div class="stat-card">
                    <h3>100%</h3>
                    <p>Local Processing</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Architecture Components</h2>
            
            <div class="architecture-diagram">
                <h3>System Flow</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>Claude Desktop</strong>
                        <p>MCP Client</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>MCP Server</strong>
                        <p>Protocol Handler</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>RAG System</strong>
                        <p>Search & Synthesis</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>Vector DB</strong>
                        <p>ChromaDB</p>
                    </div>
                </div>
            </div>

            <div class="component">
                <h4>1. MCP Complete Server (mcp_complete_server.py) - CURRENT</h4>
                <p>‚úÖ Production MCP server with 14 tools, lazy initialization, and ARM64 compatibility. Proper MCP protocol compliance with serverInfo format and JSON-RPC error handling.</p>
            </div>

            <div class="component">
                <h4>2. Vector Database (ChromaDB) - UPDATED</h4>
                <p>‚úÖ Stores 768-dimensional embeddings using sentence-transformers/all-mpnet-base-v2. Maintains index of text chunks with proper dimension compatibility. ARM64 native dependencies.</p>
            </div>

            <div class="component">
                <h4>3. Document Processing System</h4>
                <p>Processes multiple document formats from configurable directory. Uses adaptive timeout protection for large/corrupted files. Chunks text into 1200-character segments with 150-character overlap. Automatically categorizes content.</p>
            </div>

            <div class="component">
                <h4>4. Real-time Monitoring</h4>
                <p>Web dashboard at http://localhost:8888 with live progress tracking, chunk generation display, page extraction monitoring, and searchable document library. Updates every 2 seconds via AJAX polling.</p>
            </div>
        </div>

        <div class="section">
            <h2>Current File Structure</h2>
            
            <div class="file-list">
                <h3>Source Files</h3>
                <ul>
                    <li><strong>src/</strong> - Main source code directory
                        <ul>
                            <li><strong>servers/mcp_complete_server.py</strong> - ‚úÖ Main MCP server (14 tools, ARM64 compatible)</li>
                            <li><strong>core/shared_rag.py</strong> - ‚úÖ Core RAG with 768-dim embeddings & timeout protection</li>
                            <li><strong>core/config.py</strong> - Centralized configuration management</li>
                            <li><strong>core/logging_setup.py</strong> - Logging configuration</li>
                            <li><strong>indexing/index_monitor.py</strong> - Background indexing service with progress monitoring</li>
                            <li><strong>monitoring/monitor_web_enhanced.py</strong> - Real-time web dashboard with progress tracking</li>
                            <li><strong>utils/clean_pdfs.py</strong> - Automatic PDF cleaning utility</li>
                        </ul>
                    </li>
                    <li><strong>scripts/</strong> - Utility and management scripts</li>
                    <li><strong>config/</strong> - Configuration templates</li>
                    <li><strong>docs/</strong> - Documentation and images</li>
                    <li><strong>README.md</strong> - Complete deployment guide</li>
                    <li><strong>CLAUDE.md</strong> - Claude Code instructions</li>
                </ul>
            </div>

            <div class="file-list">
                <h3>Data Directories</h3>
                <ul>
                    <li><strong>books/</strong> - Document library (configurable via PERSONAL_LIBRARY_DOC_PATH)</li>
                    <li><strong>chroma_db/</strong> - Vector database storage (768-dim embeddings)</li>
                    <li><strong>venv_mcp/</strong> - ‚úÖ Python 3.12 virtual environment (ARM64 compatible)</li>
                    <li><strong>logs/</strong> - Application and service logs</li>
                    <li><strong>config/</strong> - Configuration files</li>
                    <li><strong>scripts/</strong> - Utility and management scripts</li>
                    <li><strong>docs/</strong> - Documentation and images</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üîß Usage Modes - Choose Your Workflow</h2>
            
            <div class="architecture-diagram">
                <h3>Three Flexible Modes</h3>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                    <div class="component">
                        <h4>Mode 1: Automatic</h4>
                        <p><strong>For:</strong> Most users</p>
                        <p><strong>How:</strong> Just use Claude normally</p>
                        <p><strong>When indexing happens:</strong> First query after adding books</p>
                        <code>./run.sh</code>
                    </div>
                    
                    <div class="component">
                        <h4>Mode 2: Background</h4>
                        <p><strong>For:</strong> Power users</p>
                        <p><strong>How:</strong> Run monitor service</p>
                        <p><strong>When indexing happens:</strong> Instantly on file changes</p>
                        <p><strong>Control:</strong> Pause/Resume support</p>
                        <code>./index_monitor.sh</code>
                    </div>
                    
                    <div class="component">
                        <h4>Mode 3: Manual</h4>
                        <p><strong>For:</strong> Full control</p>
                        <p><strong>How:</strong> Run when you want</p>
                        <p><strong>When indexing happens:</strong> When you trigger it</p>
                        <code>./run.sh --index-only</code>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚úÖ Available MCP Tools (14 Tools - All Working)</h2>
            
            <h3>Search & Discovery (4 tools)</h3>
            <div class="component">
                <h4>1. search</h4>
                <p>‚úÖ Semantic search with optional book filtering and synthesis</p>
                <p><em>Parameters:</em> query, limit, book_filter, synthesize</p>
            </div>

            <div class="component">
                <h4>2. list_books</h4>
                <p>List books by pattern, author, or directory</p>
                <p><em>Parameters:</em> pattern, author, directory</p>
            </div>

            <div class="component">
                <h4>3. recent_books</h4>
                <p>Find recently indexed books by time period</p>
                <p><em>Parameters:</em> hours, days</p>
            </div>

            <div class="component">
                <h4>4. find_practices</h4>
                <p>Find specific practices or techniques</p>
                <p><em>Parameter:</em> practice_type</p>
            </div>

            <h3>Content Extraction (3 tools)</h3>
            <div class="component">
                <h4>5. extract_pages</h4>
                <p>Extract specific pages from any book</p>
                <p><em>Parameters:</em> book_pattern, pages (int/list/range)</p>
            </div>

            <div class="component">
                <h4>6. extract_quotes</h4>
                <p>Find notable quotes on specific topics</p>
                <p><em>Parameters:</em> topic, max_quotes</p>
            </div>

            <div class="component">
                <h4>7. summarize_book</h4>
                <p>Generate AI summary of entire books</p>
                <p><em>Parameters:</em> book_name, summary_length (brief/detailed)</p>
            </div>

            <h3>Analysis & Synthesis (3 tools)</h3>
            <div class="component">
                <h4>8. compare_perspectives</h4>
                <p>Compare perspectives across multiple sources</p>
                <p><em>Parameter:</em> topic</p>
            </div>

            <div class="component">
                <h4>9. question_answer</h4>
                <p>Direct Q&A from your library</p>
                <p><em>Parameters:</em> question, detail_level (concise/detailed)</p>
            </div>

            <div class="component">
                <h4>10. daily_reading</h4>
                <p>Get suggested passages for daily reading</p>
                <p><em>Parameters:</em> theme, length (short/medium/long)</p>
            </div>

            <h3>System Management (4 tools)</h3>
            <div class="component">
                <h4>11. library_stats</h4>
                <p>Get library statistics and indexing status</p>
                <p><em>Shows:</em> Books, chunks, categories, status</p>
            </div>

            <div class="component">
                <h4>12. index_status</h4>
                <p>Get detailed indexing progress</p>
                <p><em>Shows:</em> Current activity, queue, history</p>
            </div>

            <div class="component">
                <h4>13. refresh_cache</h4>
                <p>Refresh search cache and reload book index</p>
                <p><em>Purpose:</em> Clear cache after adding new books</p>
            </div>

            <div class="component">
                <h4>14. warmup</h4>
                <p>Initialize RAG system to prevent timeouts</p>
                <p><em>Purpose:</em> Pre-load models for faster response</p>
            </div>
        </div>


        <div class="section">
            <h2>üöÄ Installation & Setup</h2>
            
            <div class="architecture-diagram">
                <h3>Setup Options</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>Option 1</strong>
                        <p>serviceInstall.sh</p>
                        <p style="font-size: 0.9em;">Complete with services</p>
                    </div>
                    <span class="flow-arrow">OR</span>
                    <div class="flow-item">
                        <strong>Option 2</strong>
                        <p>Automated flags</p>
                        <p style="font-size: 0.9em;">Non-interactive setup</p>
                    </div>
                    <span class="flow-arrow">OR</span>
                    <div class="flow-item">
                        <strong>Option 3</strong>
                        <p>install_interactive_nonservicemode.sh</p>
                        <p style="font-size: 0.9em;">No background services</p>
                    </div>
                </div>
            </div>

            <h3>Option 1: Comprehensive Setup (Recommended)</h3>
            <pre><code># Clone and setup with services
git clone https://github.com/hpoliset/PersonalDocLibraryRAGMCP
cd PersonalDocLibraryRAGMCP
./serviceInstall.sh</code></pre>
            
            <div class="component">
                <h4>What serviceInstall.sh does:</h4>
                <ul>
                    <li>‚úÖ Checks for Python 3.12 (installs if missing)</li>
                    <li>‚úÖ Creates virtual environment</li>
                    <li>‚úÖ Installs Python dependencies</li>
                    <li>‚úÖ Auto-installs system dependencies (ocrmypdf, LibreOffice, pandoc)</li>
                    <li>‚úÖ Configures paths interactively</li>
                    <li>‚úÖ Generates configuration files</li>
                    <li>‚úÖ Installs background indexing service (optional)</li>
                    <li>‚úÖ Installs web monitor service (optional)</li>
                    <li>‚úÖ Runs initial indexing (optional)</li>
                </ul>
            </div>

            <h3>Option 2: Automated Setup</h3>
            <pre><code># Non-interactive setup with all services
./serviceInstall.sh --books-path /path/to/books \
  --install-service --start-web-monitor --non-interactive</code></pre>

            <h3>Option 3: Interactive Without Services</h3>
            <pre><code># For manual control without background services
./install_interactive_nonservicemode.sh</code></pre>

            <h3>‚úÖ Claude Desktop Configuration</h3>
            <div class="success">
                <p>After installation, add to Claude Desktop's config (~/.Library/Application Support/Claude/claude_desktop_config.json):</p>
                <pre><code>{
  "mcpServers": {
    "personal-library": {
      "command": "/path/to/your/DocumentIndexerMCP/venv_mcp/bin/python",
      "args": ["/path/to/your/DocumentIndexerMCP/src/servers/mcp_complete_server.py"],
      "env": {
        "PYTHONUNBUFFERED": "1"
      }
    }
  }
}</code></pre>
                <p><strong>Note:</strong> The config file is auto-generated in config/claude_desktop_config.json during setup</p>
            </div>

            <h3>Manual Operations</h3>
            <div class="component">
                <h4>Running the MCP Server Manually</h4>
                <pre><code># Start MCP server for Claude Desktop
./scripts/run.sh

# Index documents only
./scripts/run.sh --index-only

# Index with retry for large collections
./scripts/run.sh --index-only --retry</code></pre>
                
                <h4>When to use manual mode:</h4>
                <ul>
                    <li>See real-time indexing progress</li>
                    <li>Force complete re-indexing</li>
                    <li>Debug issues</li>
                    <li>Process large document batches</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üìñ Adding New Books - Workflow</h2>
            
            <div class="architecture-diagram">
                <h3>When You Add New Books/Documents</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>Add Documents</strong>
                        <p>Copy to books/</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item" style="background: #fff3cd; border-color: #ffc107;">
                        <strong>Choose Method</strong>
                        <p>Auto or Manual?</p>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                    <div class="flow-item" style="flex: 1; margin: 10px;">
                        <strong>Automatic</strong>
                        <p>Just use Claude normally</p>
                        <p style="font-size: 0.9em; color: #666;">First query will be slower</p>
                    </div>
                    <div class="flow-item" style="flex: 1; margin: 10px;">
                        <strong>Manual</strong>
                        <p>Run ./run.sh</p>
                        <p style="font-size: 0.9em; color: #666;">See indexing progress</p>
                    </div>
                </div>
            </div>

            <div class="warning">
                <strong>‚ö†Ô∏è Supported Formats:</strong>
                <ul>
                    <li>PDF (.pdf) - Including scanned PDFs with OCR</li>
                    <li>Word (.docx, .doc) - Requires LibreOffice</li>
                    <li>PowerPoint (.pptx, .ppt) - Requires LibreOffice</li>
                    <li>EPUB (.epub) - Requires pandoc</li>
                    <li>MOBI/Kindle (.mobi, .azw, .azw3) - Uses Calibre if available</li>
                    <li>Text (.txt) - Plain text files</li>
                </ul>
            </div>

            <h3>üîß Automatic PDF Cleaning</h3>
            <div class="success">
                <h4>‚ú® No Manual Intervention Needed!</h4>
                <p>The system automatically handles problematic PDFs via <code>shared_rag.py</code>:</p>
                
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>PDF Fails</strong>
                        <p>During indexing</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>Auto Clean</strong>
                        <p>Via Ghostscript</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>Backup Original</strong>
                        <p>to books/originals/</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>Index Cleaned</strong>
                        <p>On next start</p>
                    </div>
                </div>
                
                <p><strong>Automatically fixes:</strong></p>
                <ul>
                    <li>‚úÖ Very large PDFs (>100MB)</li>
                    <li>‚úÖ Complex formatting or embedded objects</li>
                    <li>‚úÖ Corrupted or malformed PDFs</li>
                    <li>‚úÖ Font embedding issues</li>
                </ul>
            </div>
            
            <div class="component">
                <h4>Manual Cleaning (Optional)</h4>
                <p>For specific PDFs or batch processing:</p>
                <pre><code># Force clean specific PDFs
python clean_pdfs.py</code></pre>
                
                <p><strong>Status tracking:</strong> Check <code>failed_pdfs.json</code> for processing history</p>
                
                <div class="warning">
                    <strong>Prerequisite:</strong> Install Ghostscript with <code>brew install ghostscript</code>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìö Indexing Process - How It Works</h2>
            
            <div class="architecture-diagram">
                <h3>Indexing Workflow</h3>
                <div class="flow-diagram">
                    <div class="flow-item">
                        <strong>PDF Files</strong>
                        <p>books/*.pdf</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>PyPDF2</strong>
                        <p>Extract Text</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>LangChain</strong>
                        <p>Chunk Text</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>HuggingFace</strong>
                        <p>Create Embeddings</p>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-item">
                        <strong>ChromaDB</strong>
                        <p>Store Vectors</p>
                    </div>
                </div>
            </div>

            <div class="component">
                <h4>üîç Where Indexing Happens</h4>
                <p>The indexing logic is in <code>src/core/shared_rag.py</code> in the <strong>SpiritualLibraryRAG</strong> class. When documents are processed, it automatically:</p>
                <ol>
                    <li>Checks for new documents in the configured directory</li>
                    <li>Compares file hashes with <code>chroma_db/book_index.json</code></li>
                    <li>Indexes any new or modified documents</li>
                    <li>Supports PDF, Word, EPUB, MOBI, and text formats</li>
                </ol>
            </div>

            <h3>Library Roles & Responsibilities</h3>
            
            <div class="component">
                <h4>1. PyPDF2 - PDF Text Extraction</h4>
                <p><strong>Purpose:</strong> Extracts raw text from PDF files</p>
                <p><strong>Process:</strong> Reads each page and converts to plain text, handling various PDF formats and encodings</p>
                <pre><code># Example usage in the code:
pdf_reader = PyPDF2.PdfReader(pdf_file)
for page in pdf_reader.pages:
    text = page.extract_text()</code></pre>
            </div>

            <div class="component">
                <h4>2. LangChain - Text Processing & Chunking</h4>
                <p><strong>Purpose:</strong> Intelligently splits text into manageable chunks for embedding</p>
                <p><strong>Configuration:</strong></p>
                <ul>
                    <li>Chunk size: 1000 characters</li>
                    <li>Chunk overlap: 200 characters</li>
                    <li>Preserves context across chunk boundaries</li>
                </ul>
                <pre><code># Text splitting configuration:
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=1200,
    chunk_overlap=150,
    length_function=len
)</code></pre>
            </div>

            <div class="component">
                <h4>3. HuggingFace Transformers - Creating Embeddings</h4>
                <p><strong>Purpose:</strong> Converts text chunks into numerical vectors for semantic search</p>
                <p><strong>Model:</strong> sentence-transformers/all-mpnet-base-v2 (CURRENT)</p>
                <p><strong>Why this model:</strong></p>
                <ul>
                    <li>Higher quality embeddings</li>
                    <li>768-dimensional vectors</li>
                    <li>Compatible with existing ChromaDB</li>
                    <li>Better semantic understanding</li>
                </ul>
                <pre><code># Embedding creation:
embeddings = HuggingFaceEmbeddings(
    model_name="sentence-transformers/all-mpnet-base-v2",
    model_kwargs={'device': device},
    encode_kwargs={'normalize_embeddings': True}
)</code></pre>
            </div>

            <div class="component">
                <h4>4. ChromaDB - Vector Storage & Retrieval</h4>
                <p><strong>Purpose:</strong> Stores embeddings and enables fast similarity search</p>
                <p><strong>Features:</strong></p>
                <ul>
                    <li>Persistent storage in <code>chroma_db/</code></li>
                    <li>Metadata filtering (by book, type, etc.)</li>
                    <li>Efficient k-nearest neighbor search</li>
                </ul>
                <pre><code># Vector storage:
vector_store = Chroma(
    persist_directory="./chroma_db",
    embedding_function=embeddings
)</code></pre>
            </div>

            <div class="component">
                <h4>5. Local LLM Integration (Optional)</h4>
                <p><strong>Purpose:</strong> Can optionally use local LLMs for enhanced synthesis</p>
                <p><strong>Integration:</strong> Works with Ollama or other local models</p>
                <p><strong>Status:</strong> ‚ö†Ô∏è <strong>OPTIONAL</strong> - Not required for core functionality</p>
                <p><strong>Usage when enabled:</strong></p>
                <ul>
                    <li>Enhanced synthesis across multiple sources</li>
                    <li>Advanced question answering with context</li>
                    <li>Comparative analysis across documents</li>
                    <li>All processing happens locally</li>
                </ul>
                <p><strong>Note:</strong> The system works fully without Ollama. All 14 MCP tools function using vector search and retrieval alone.</p>
            </div>
        </div>

        <div class="section">
            <h2>üîÑ Complete Data Flow</h2>
            
            <div class="architecture-diagram">
                <h3>From Query to Response</h3>
                <ol>
                    <li><strong>User Query</strong> ‚Üí Claude Desktop sends query via MCP protocol</li>
                    <li><strong>Query Processing</strong> ‚Üí mcp_complete_server.py receives and parses request</li>
                    <li><strong>Embedding Creation</strong> ‚Üí HuggingFace converts query to vector</li>
                    <li><strong>Vector Search</strong> ‚Üí ChromaDB finds similar chunks (cosine similarity)</li>
                    <li><strong>Context Retrieval</strong> ‚Üí Top k chunks retrieved with metadata</li>
                    <li><strong>Response Assembly</strong> ‚Üí Results formatted and returned (LLM synthesis optional)</li>
                    <li><strong>Response Delivery</strong> ‚Üí Formatted response sent back to Claude</li>
                </ol>
            </div>

            <div class="warning">
                <strong>‚ö†Ô∏è Indexing Triggers:</strong>
                <ul>
                    <li>First server start (initial indexing)</li>
                    <li>New PDF added to books/ directory</li>
                    <li>Existing PDF modified (hash mismatch)</li>
                    <li>Manual re-indexing (delete chroma_db/book_index.json)</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>Technical Details</h2>
            
            <div class="success">
                <strong>‚úÖ Current Performance:</strong>
                <ul>
                    <li>Startup time: <2 seconds (lazy initialization)</li>
                    <li>Search latency: ~1.75s per query (768-dim embeddings)</li>
                    <li>Memory usage: ~4GB for embedding model</li>
                    <li>ARM64 native: All dependencies optimized for Apple Silicon</li>
                    <li>Supports: PDF, Word, EPUB, MOBI, PowerPoint, Text files</li>
                </ul>
            </div>

            <div class="warning">
                <strong>‚ö†Ô∏è Important Notes:</strong>
                <ul>
                    <li>First-time indexing can take 10-30 minutes</li>
                    <li>All processing is local - no external API calls</li>
                    <li>Documents indexed automatically or via background service</li>
                    <li>Ollama/LLM integration is optional, not required</li>
                </ul>
            </div>

            <div class="success">
                <strong>‚úÖ System Features:</strong>
                <ul>
                    <li>Semantic search with context-aware results</li>
                    <li>Automatic content categorization</li>
                    <li>Multi-source synthesis capabilities</li>
                    <li>Fact-checking against authoritative texts</li>
                    <li>Chapter outline generation</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üîí Lock Management & Conflict Resolution</h2>
            
            <div class="architecture-diagram">
                <h3>How Lock Conflicts are Prevented</h3>
                
                <div class="component">
                    <h4>File-Based Locking System</h4>
                    <p><strong>Lock File:</strong> /tmp/spiritual_library_index.lock</p>
                    <p><strong>Contains:</strong> Process ID and timestamp</p>
                    <p><strong>Auto-cleanup:</strong> Detects and removes stale locks from dead processes</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div class="component">
                        <h4>MCP Server Behavior</h4>
                        <p>When lock is held by another process:</p>
                        <ul style="list-style: none; padding: 10px 0;">
                            <li>‚úÖ Proceeds immediately with existing index</li>
                            <li>‚úÖ No delay for users</li>
                            <li>‚úÖ Logs that another process is indexing</li>
                        </ul>
                    </div>
                    
                    <div class="component">
                        <h4>Background Monitor Behavior</h4>
                        <p>When lock is held by another process:</p>
                        <ul style="list-style: none; padding: 10px 0;">
                            <li>‚è±Ô∏è Schedules retry after delay</li>
                            <li>‚è±Ô∏è 2s delay (normal) or 5s (service mode)</li>
                            <li>‚è±Ô∏è Keeps trying until successful</li>
                        </ul>
                    </div>
                </div>
                
                <div class="warning" style="margin-top: 20px;">
                    <strong>Stale Lock Detection:</strong>
                    <ul>
                        <li>Checks if lock holder process is still alive</li>
                        <li>Considers locks older than 30 minutes as stale</li>
                        <li>Automatically cleans up on next access attempt</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üñ•Ô∏è Web Monitoring Interface - How It Works</h2>
            
            <div class="architecture-diagram">
                <h3>System Architecture</h3>
                <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     JSON Files      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Index Monitor  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>  ‚îÇ index_status.json‚îÇ
‚îÇ   (Backend)     ‚îÇ                      ‚îÇindexing_progress ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                 ‚Üë
                                                 ‚îÇ Reads every 2s
                                                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      Flask API       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Web Browser   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Web Monitor     ‚îÇ
‚îÇ  (localhost:8888)‚îÇ     JSON Response   ‚îÇ  (Flask Server)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                </pre>
            </div>

            <div class="component">
                <h4>1. Data Flow Architecture</h4>
                <p><strong>Backend Updates:</strong> The indexing service (index_monitor.py) continuously writes status to JSON files:</p>
                <ul>
                    <li><code>chroma_db/index_status.json</code> - Overall indexing status</li>
                    <li><code>chroma_db/indexing_progress.json</code> - Detailed progress (pages, chunks, stage)</li>
                </ul>
                <p><strong>Web Monitor Reads:</strong> Flask server reads these files and serves via REST API</p>
                <p><strong>Frontend Polling:</strong> Browser fetches updates every 2 seconds via AJAX</p>
            </div>

            <div class="component">
                <h4>2. REST API Endpoints</h4>
                <ul style="list-style: none; padding: 10px 0;">
                    <li><code>/</code> - Main dashboard HTML interface</li>
                    <li><code>/api/status</code> - Current indexing status with progress</li>
                    <li><code>/api/stats</code> - Library statistics (books, chunks)</li>
                    <li><code>/api/books</code> - List of indexed books</li>
                    <li><code>/api/failed</code> - Failed documents list</li>
                </ul>
            </div>

            <div class="component">
                <h4>3. Real-Time Updates (JavaScript)</h4>
                <pre><code>// Frontend polls every 2 seconds
setInterval(async () => {
    const response = await fetch('/api/status');
    const data = await response.json();
    updateUI(data);
}, 2000);</code></pre>
                <p>Updates happen without page refresh using JavaScript DOM manipulation</p>
            </div>

            <div class="component">
                <h4>4. Progress Tracking Details</h4>
                <p>The monitor displays multiple levels of progress:</p>
                <ul>
                    <li><strong>Document Progress:</strong> 318/1121 (28.4%)</li>
                    <li><strong>Current File:</strong> Name of document being processed</li>
                    <li><strong>Processing Stage:</strong>
                        <ul>
                            <li>üìñ Loading - Reading document from disk</li>
                            <li>‚úÇÔ∏è Chunking - Splitting into text chunks</li>
                            <li>üîÑ Embedding - Creating vectors</li>
                            <li>‚úÖ Completed - Successfully indexed</li>
                        </ul>
                    </li>
                    <li><strong>Page Progress:</strong> For PDFs, shows actual page numbers (e.g., 5576/39883)</li>
                    <li><strong>Chunks Generated:</strong> Number of text chunks created</li>
                    <li><strong>Batch Progress:</strong> During embedding (e.g., Batch 5/8)</li>
                </ul>
            </div>

            <div class="architecture-diagram">
                <h3>Real-Time Status Dashboard</h3>
                <p>Access at <strong>http://localhost:8888</strong> when running <code>monitor_web_enhanced.py</code></p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                    <div class="component">
                        <h4>Live Information Display</h4>
                        <ul style="list-style: none; padding: 10px 0;">
                            <li>üìä Current indexing status</li>
                            <li>üìà Progress bar with percentage</li>
                            <li>üìö Library statistics</li>
                            <li>üîí Lock status and health</li>
                            <li>üìÅ Pending files queue</li>
                            <li>üìÑ Current page extraction progress</li>
                            <li>üì¶ Chunk generation count</li>
                            <li>üíæ Memory usage tracking</li>
                        </ul>
                    </div>
                    
                    <div class="component">
                        <h4>Interactive Features</h4>
                        <ul style="list-style: none; padding: 10px 0;">
                            <li>üîÑ Manual index trigger button</li>
                            <li>‚ö° Auto-refresh (2s when indexing)</li>
                            <li>üìù Recent activity log</li>
                            <li>‚ö†Ô∏è Failed document alerts</li>
                            <li>üé® Modern, responsive UI</li>
                            <li>‚è∏Ô∏è Pause/Resume controls</li>
                            <li>üîç Searchable book table</li>
                            <li>‚å®Ô∏è Enter key for search</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="success">
                <h4>5. Decoupled Architecture Benefits</h4>
                <p>The web monitor is completely decoupled from the indexer:</p>
                <ul>
                    <li>‚úÖ Read-only observation - doesn't interfere with indexing</li>
                    <li>‚úÖ Can start/stop independently of indexer</li>
                    <li>‚úÖ Multiple monitors can run simultaneously</li>
                    <li>‚úÖ No performance impact on indexing process</li>
                    <li>‚úÖ Works with any process that writes to the JSON files</li>
                </ul>
            </div>

            <div class="warning">
                <h4>6. Visual Progress Indicators</h4>
                <p>The interface uses emojis and colors to indicate status:</p>
                <ul>
                    <li>üü¢ Green progress bar for active indexing</li>
                    <li>üîµ Blue indicators for processing stages</li>
                    <li>üü° Yellow for warnings or slow operations</li>
                    <li>üî¥ Red for errors or failures</li>
                    <li>‚è∏Ô∏è Gray when paused</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üöÄ Service Mode (LaunchAgent)</h2>
            
            <div class="success">
                <h4>Run Index Monitor as System Service</h4>
                <p>For users who want automatic background indexing on system startup:</p>
            </div>
            
            <div class="architecture-diagram">
                <h3>Service Management Commands</h3>
                <pre><code># Install and start service
./install_service.sh

# Check service status and health
./service_status.sh

# Stop and uninstall service
./uninstall_service.sh</code></pre>
                
                <div class="component" style="margin-top: 20px;">
                    <h4>Service Features</h4>
                    <ul style="list-style: none; padding: 10px 0;">
                        <li>üöÄ Starts automatically on system boot</li>
                        <li>üîÑ Auto-restart on failure (30s delay)</li>
                        <li>üéØ Lower priority (nice 10)</li>
                        <li>‚è±Ô∏è Longer retry delays (5s vs 2s)</li>
                        <li>üìù Separate log files for stdout/stderr</li>
                        <li>üõ°Ô∏è Graceful shutdown handling</li>
                        <li>‚è∏Ô∏è <strong>NEW:</strong> Pause/Resume support</li>
                        <li>üìä <strong>NEW:</strong> Real-time progress tracking</li>
                    </ul>
                </div>
            </div>

            <div class="success" style="margin-top: 30px;">
                <h4>üéÆ Pause/Resume Control (NEW)</h4>
                <p>Control indexing without stopping the service:</p>
                <pre><code># Pause indexing (completes current PDF first)
./scripts/pause_indexing.sh

# Resume indexing
./scripts/resume_indexing.sh

# Check comprehensive status
./scripts/indexing_status.sh</code></pre>
                
                <div class="flow-diagram" style="margin-top: 20px;">
                    <div class="flow-item">
                        <strong>Running</strong>
                        <p>Indexing active</p>
                    </div>
                    <span class="flow-arrow">‚è∏Ô∏è</span>
                    <div class="flow-item" style="background: #fff3cd;">
                        <strong>Paused</strong>
                        <p>Queues new files</p>
                    </div>
                    <span class="flow-arrow">‚ñ∂Ô∏è</span>
                    <div class="flow-item">
                        <strong>Resumed</strong>
                        <p>Processes queue</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Troubleshooting</h2>
            
            <h3>Common Issues</h3>
            <ul>
                <li><strong>Import errors:</strong> Ensure virtual environment is activated</li>
                <li><strong>Memory issues:</strong> Ensure ~4GB RAM for embedding model</li>
                <li><strong>Search not working:</strong> Check if documents are properly indexed in ChromaDB</li>
                <li><strong>Ollama (if used):</strong> Optional - install with <code>brew install ollama</code></li>
                <li><strong>Lock conflicts:</strong> Check lock status with <code>./service_status.sh</code></li>
                <li><strong>Service won't start:</strong> Check logs in <code>index_monitor_stderr.log</code></li>
            </ul>

            <h3>Logs Location</h3>
            <ul>
                <li><code>mcp_startup.log</code> - Startup logs</li>
                <li><code>mcp_server_stdout.log</code> - Server output</li>
                <li><code>mcp_server_stderr.log</code> - Error logs</li>
                <li><code>index_monitor_stdout.log</code> - Background monitor output</li>
                <li><code>index_monitor_stderr.log</code> - Background monitor errors</li>
            </ul>
        </div>
    </div>
</body>
</html>